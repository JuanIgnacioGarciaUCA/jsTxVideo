<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="./pwa-logo.ico" type="image/x-icon">
    <link rel="stylesheet" href="stylesheet.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsTxVideo - Cam Streamer</title>
    
    <meta name="theme-color" content="#2196F3">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- LibrerÃ­as Externas -->
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>
<body>
    <!-- Capa negra que cubrirÃ¡ todo -->
    <div id="blackOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:10000; color:#222; text-align:center; padding-top:50%;">
        <p>Transmitiendo en modo ahorro...</p>
        <p style="font-size: 0.8rem;">(Haz doble clic para volver)</p>
    </div>

    <!-- En el panel del emisor aÃ±ade este botÃ³n -->
    <button id="btnStealth" class="btn-stealth" style="background:#444; color:white;">MODO AHORRO (PANTALLA NEGRA)</button>

    <header>
        <h1>jsTxVideo.Cam 2</h1>
    </header>

    <div class="container">
        <!-- Panel Emisor -->
        <div class="panel">
            <strong>EMISOR:</strong>
            <p>Tu ID: <span id="my-id" class="id-text">Cargando...</span></p>
            <div id="qrcode"></div>
            <button id="btnStart" class="btn-start">ACTIVAR MI CÃMARA</button>
            <p class="status">Pulsa aquÃ­ para empezar a transmitir</p>
        </div>

        <!-- Visualizador de Video -->
        <!--video id="webcam" autoplay playsinline></video-->
        <!-- Cambiamos ligeramente el HTML para usar un canvas -->
        <div class="panel">
            <div style="position: relative; display: inline-block; width: 100%; max-width: 640px;">
                <!-- El video estarÃ¡ oculto, solo lo usamos como fuente de datos -->
                <video id="webcam" autoplay playsinline style="display: block;"></video>
                <!-- El canvas mostrarÃ¡ el video + los recuadros -->
                <!-- canvas id="overlay" width="640" height="480" style="width: 100%; height: auto; background: #000; border-radius: 8px;"></canvas-->
            </div>
        </div>
    </div>
</body>
</html>

<script>
const worker = new Worker('worker.js');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1. SISTEMA DE LOGS EN PANTALLA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const logArea = document.createElement('div');
Object.assign(logArea.style, {
    background: 'rgba(0, 0, 0, 0.8)',
    color: '#0f0',
    fontFamily: 'monospace',
    fontSize: '11px',
    padding: '10px',
    height: '100px',
    overflowY: 'scroll',
    width: '100%',
    position: 'fixed',
    bottom: '0',
    left: '0',
    zIndex: '10001',
    boxSizing: 'border-box',
    pointerEvents: 'none' // Para que no bloquee clics
});

document.body.appendChild(logArea);

function log(msg) {
    const now = new Date().toLocaleTimeString();
    logArea.innerHTML += `[${now}] ${msg}<br>`;
    logArea.scrollTop = logArea.scrollHeight;
    console.log("[jsTxVideo]", msg);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2. REFERENCIAS DOM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const videoElement  = document.getElementById('webcam');
const overlayCanvas = document.getElementById('overlay');
const overlayCtx    = overlayCanvas.getContext('2d', { willReadFrequently: true });
const btnStart      = document.getElementById('btnStart');
const myIdDisplay   = document.getElementById('my-id');
const qrContainer   = document.getElementById('qrcode');
const btnStealth    = document.getElementById('btnStealth');
const blackOverlay  = document.getElementById('blackOverlay');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 3. VARIABLES GLOBALES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let localStream = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 5. CONFIGURACIÃ“N PEERJS (P2P)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const peer = new Peer(undefined, {
    config: {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun.stunprotocol.org' },
            { 
                urls: 'turn:openrelay.metered.ca:80', 
                username: 'openrelayproject', 
                credential: 'openrelayproject' 
            },
            { 
                urls: 'turn:openrelay.metered.ca:443', 
                username: 'openrelayproject', 
                credential: 'openrelayproject' 
            }
        ]
    }
});

peer.on('open', id => {
    log(`Mi ID: ${id}`);
    myIdDisplay.textContent = id;
    generarQR(id);
    revisarUrlParaConexion();
});

peer.on('error', err => log(`Error PeerJS: ${err.type}`));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 6. LÃ“GICA EMISOR (EL MÃ“VIL)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnStart.addEventListener('click', async () => {
    try {
        log("Abriendo cÃ¡mara trasera (640x480)...");
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "environment",
                width: { ideal: 640 },
                height: { ideal: 480 }
            },
            audio: false
        });

        localStream = stream;
        videoElement.srcObject = stream;
        videoElement.play();

        // Wake Lock para evitar que se apague la pantalla
        if ('wakeLock' in navigator) {
            await navigator.wakeLock.request('screen');
            log("WakeLock activo ğŸ’¡");
        }

        btnStart.textContent = "CÃMARA ACTIVADA âœ…";
        btnStart.style.backgroundColor = "#2e7d32";
    } catch (err) {
        log("Error cÃ¡mara: " + err.message);
    }
});

// El emisor recibe la llamada
peer.on('call', call => {
    log("ğŸ“ Llamada entrante...");
    call.answer(localStream); // Responde con el video (si existe)

    call.on('stream', remoteStream => {
        // En caso de que el receptor tambiÃ©n envÃ­e video
        mostrarVideo(remoteStream);
    });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 9. FUNCIONES AUXILIARES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generarQR(id) {
    qrContainer.innerHTML = "";
    const url = `${window.location.origin}${window.location.pathname}?connect=${id}`;
    new QRCode(qrContainer, { text: url, width: 150, height: 150 });
}

function revisarUrlParaConexion() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('connect');
    if (id) {
        remoteIdInput.value = id;
        log("ID detectado de URL.");
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 10. MODO AHORRO (PANTALLA NEGRA)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnStealth.addEventListener('click', () => {
    if (!localStream) return alert("Activa la cÃ¡mara primero");
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(() => {});
    }
    blackOverlay.style.display = 'block';
    log("Modo ahorro: ON");
});

blackOverlay.addEventListener('click', () => {
    blackOverlay.style.display = 'none';
    if (document.fullscreenElement && document.exitFullscreen) {
        document.exitFullscreen().catch(() => {});
    }
    log("Modo ahorro: OFF");
});

log("app.js cargado âœ“");
</script>
